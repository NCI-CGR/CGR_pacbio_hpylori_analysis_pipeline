#!/bin/bash
. ./global_bash_config.rc

BARCODING_JOB=$1
shift;
BARCODES=$*


for i in $BARCODES;do
	OUT_HGAP=${ROOT_DIR}/file_${BARCODING_JOB}_${i}_${i}/HGAP_run
	LOG_DIR=${ROOT_DIR}/file_${BARCODING_JOB}_${i}_${i}/logs
	mkdir -p $OUT_HGAP 2>/dev/null
	mkdir -p $LOG_DIR 2>/dev/null
	rm ${LOG_DIR}/step2_HGAP_file${BARCODING_JOB}_${i}_${i}.std* 2>/dev/null
	
	SUBREADS_XML=$(ls /CGF/Resources/PacBio/smrtlink/userdata/jobs_root/000/000${BARCODING_JOB}/tasks/pbcoretools.tasks.update_barcoded_sample_metadata-0/lima_output.lbc${i}*.subreadset.xml)
	echo $SUBREADS_XML
	#CMD="qsub -cwd -q $QUEUE -N HGAP_file${BARCODING_JOB}_${i}_${i} -e ${LOG_DIR}/step2_HGAP_file${BARCODING_JOB}_${i}_${i}.stderr -o ${LOG_DIR}/step2_HGAP_file${BARCODING_JOB}_${i}_${i}.stdout -b y \"/CGF/Resources/PacBio/smrtlink/current/bundles/smrttools/smrtcmds/bin/pbsmrtpipe pipeline-id pbsmrtpipe.pipelines.polished_falcon_fat -e eid_subread:${ROOT_DIR}/file_${BARCODING_JOB}_${i}_${i}/file_${BARCODING_JOB}_filtered.${i}-${i}.subreads.xml --preset-json=${HGAP_JSON} --output-dir=${OUT_HGAP}\""
	CMD="qsub -cwd -q $QUEUE -N HGAP_file${BARCODING_JOB}_${i}_${i} -e ${LOG_DIR}/step2_HGAP_file${BARCODING_JOB}_${i}_${i}.stderr -o ${LOG_DIR}/step2_HGAP_file${BARCODING_JOB}_${i}_${i}.stdout -b y \"/CGF/Resources/PacBio/smrtlink/current/bundles/smrttools/smrtcmds/bin/pbsmrtpipe pipeline-id pbsmrtpipe.pipelines.polished_falcon_fat -e eid_subread:$SUBREADS_XML --preset-json=${HGAP_JSON} --output-dir=${OUT_HGAP}\""
	echo $CMD > nohup_step2.txt
	echo $CMD
	eval $CMD

done


